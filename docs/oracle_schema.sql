-- =============================================
-- [AI 면접 플랫폼] Oracle Database Schema Design
-- =============================================
-- 작성자: Antigravity Agent
-- 설명: AI 모의면접 시스템을 위한 오라클 테이블 스키마 설계.
--       기존 사용자/면접/기록 테이블과 상세 평가 루브릭 테이블을 통합함.
-- =============================================

-- =============================================
-- 0. CLEANUP (기존 테이블 삭제)
-- =============================================
BEGIN
    FOR t IN (SELECT table_name FROM user_tables WHERE table_name IN (
        'INTERVIEW_EVALUATIONS', 'INTERVIEW_QUESTIONS', 'RUBRIC_LEVELS', 
        'EVALUATION_ITEMS', 'COMPANY_TECH_STACKS', 'JOB_POSTINGS', 
        'RUBRIC_CATEGORIES', 'COMPANIES', 'JOB_ROLES',
        'EVALUATION_REPORTS', 'TRANSCRIPTS', 'QUESTIONS', 'INTERVIEWS', 'USERS'
    )) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        NULL; -- 테이블이 없으면 무시
END;
/

-- =============================================
-- 1. USERS (사용자 관리)
-- =============================================
CREATE TABLE USERS (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL VARCHAR2(100) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    NAME VARCHAR2(50) NOT NULL,
    ROLE VARCHAR2(20) DEFAULT 'CANDIDATE' CHECK (ROLE IN ('CANDIDATE', 'RECRUITER', 'ADMIN')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE USERS IS '사용자 계정 및 역할 정보';
COMMENT ON COLUMN USERS.ROLE IS '사용자 권한 (지원자, 채용담당자, 관리자)';

-- =============================================
-- 2. INTERVIEWS (면접 세션 및 사용자 입력 정보)
-- =============================================
CREATE TABLE INTERVIEWS (
    INTERVIEW_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER REFERENCES USERS(USER_ID) ON DELETE CASCADE,
    
    -- [사용자 입력 데이터]
    RESUME_FILE_PATH VARCHAR2(500),
    RESUME_TEXT CLOB,
    TARGET_JOB_TITLES CLOB CHECK (TARGET_JOB_TITLES IS JSON), 
    
    -- [세션 상태 관리]
    JOB_POSTING_ID NUMBER,
    STATUS VARCHAR2(20) DEFAULT 'SCHEDULED' CHECK (STATUS IN ('SCHEDULED', 'LIVE', 'COMPLETED', 'ANALYZING', 'DONE')),
    START_TIME TIMESTAMP,
    END_TIME TIMESTAMP,
    OVERALL_SCORE NUMBER(5, 2),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE INTERVIEWS IS '면접 세션 정보 및 지원자 입력 스펙';
COMMENT ON COLUMN INTERVIEWS.RESUME_TEXT IS 'RAG 분석을 위해 이력서 PDF/Word에서 추출한 원문 텍스트';
COMMENT ON COLUMN INTERVIEWS.TARGET_JOB_TITLES IS '사용자가 선택한 3가지 지원 분야 (JSON Array)';

-- =============================================
-- 3. QUESTIONS (질문 은행 - LegacySimple, 필요시 INTERVIEW_QUESTIONS와 통합 고려)
-- =============================================
CREATE TABLE QUESTIONS (
    QUESTION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CONTENT CLOB NOT NULL,
    CATEGORY VARCHAR2(100),
    DIFFICULTY NUMBER(1) DEFAULT 1 CHECK (DIFFICULTY BETWEEN 1 AND 5),
    RUBRIC_JSON CLOB CHECK (RUBRIC_JSON IS JSON),
    VECTOR_ID VARCHAR2(255)
);

COMMENT ON TABLE QUESTIONS IS '면접 질문 풀 (Legacy 구조)';

-- =============================================
-- 4. TRANSCRIPTS (대화 기록)
-- =============================================
CREATE TABLE TRANSCRIPTS (
    TRANSCRIPT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INTERVIEW_ID NUMBER REFERENCES INTERVIEWS(INTERVIEW_ID) ON DELETE CASCADE,
    SPEAKER VARCHAR2(10) CHECK (SPEAKER IN ('AI', 'USER')),
    CONTENT CLOB,
    SENTIMENT_SCORE NUMBER(4, 3),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE TRANSCRIPTS IS '면접 실시간 대화 로그 (STT/TTS)';

-- =============================================
-- 5. EVALUATION_REPORTS (최종 평가 리포트)
-- =============================================
CREATE TABLE EVALUATION_REPORTS (
    REPORT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INTERVIEW_ID NUMBER REFERENCES INTERVIEWS(INTERVIEW_ID) ON DELETE CASCADE,
    TECHNICAL_SCORE NUMBER(5, 2),
    COMMUNICATION_SCORE NUMBER(5, 2),
    CULTURAL_FIT_SCORE NUMBER(5, 2),
    SUMMARY_TEXT CLOB,
    DETAILS_JSON CLOB CHECK (DETAILS_JSON IS JSON),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE EVALUATION_REPORTS IS '면접 종료 후 생성되는 종합 분석 결과';

-- =============================================
-- 6. JOB_ROLES (직무 정보)
-- =============================================
CREATE TABLE job_roles (
    role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_name VARCHAR2(50) NOT NULL UNIQUE,
    description CLOB
);
COMMENT ON TABLE job_roles IS '직무 정보 (Job Roles)';
COMMENT ON COLUMN job_roles.role_id IS '직무 ID';
COMMENT ON COLUMN job_roles.role_name IS '직무명 (Frontend, Backend 등)';
COMMENT ON COLUMN job_roles.description IS '직무 설명';

-- =============================================
-- 7. COMPANIES (기업 정보)
-- =============================================
CREATE TABLE companies (
    company_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    industry VARCHAR2(50),
    vision CLOB,
    core_values CLOB,
    homepage_url VARCHAR2(255)
);
COMMENT ON TABLE companies IS '기업 정보 (Companies)';

-- =============================================
-- 8. RUBRIC_CATEGORIES (평가 카테고리)
-- =============================================
CREATE TABLE rubric_categories (
    category_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    description CLOB,
    weight NUMBER DEFAULT 1.0
);
COMMENT ON TABLE rubric_categories IS '평가 카테고리 (Rubric Categories)';

-- =============================================
-- 9. JOB_POSTINGS (채용 공고)
-- =============================================
CREATE TABLE job_postings (
    posting_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id NUMBER REFERENCES companies(company_id) ON DELETE CASCADE,
    role_id NUMBER REFERENCES job_roles(role_id),
    title VARCHAR2(200) NOT NULL,
    requirements CLOB,
    preferred_qualifications CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE job_postings IS '채용 공고 (Job Postings)';

-- =============================================
-- 10. COMPANY_TECH_STACKS (회사 기술 스택)
-- =============================================
CREATE TABLE company_tech_stacks (
    company_id NUMBER REFERENCES companies(company_id) ON DELETE CASCADE,
    tech_name VARCHAR2(50),
    PRIMARY KEY (company_id, tech_name)
);
COMMENT ON TABLE company_tech_stacks IS '회사 기술 스택 (Company Tech Stacks)';

-- =============================================
-- 11. EVALUATION_ITEMS (세부 평가 항목)
-- =============================================
CREATE TABLE evaluation_items (
    item_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    category_id NUMBER REFERENCES rubric_categories(category_id),
    item_name VARCHAR2(200) NOT NULL,
    definition CLOB
);
COMMENT ON TABLE evaluation_items IS '세부 평가 항목 (Evaluation Items)';

-- =============================================
-- 12. RUBRIC_LEVELS (루브릭 레벨)
-- =============================================
CREATE TABLE rubric_levels (
    level_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    item_id NUMBER REFERENCES evaluation_items(item_id) ON DELETE CASCADE,
    score NUMBER NOT NULL,
    description CLOB
);
COMMENT ON TABLE rubric_levels IS '루브릭 레벨 (Rubric Levels)';

-- =============================================
-- 13. INTERVIEW_QUESTIONS (면접 질문 상세)
-- =============================================
CREATE TABLE interview_questions (
    question_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id NUMBER REFERENCES job_roles(role_id),
    category_id NUMBER REFERENCES rubric_categories(category_id),
    question_text CLOB NOT NULL,
    intent CLOB,
    ideal_answer CLOB
);
COMMENT ON TABLE interview_questions IS '면접 질문 (Interview Questions)';

-- =============================================
-- 14. INTERVIEW_EVALUATIONS (세부 평가 결과)
-- =============================================
CREATE TABLE interview_evaluations (
    evaluation_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    session_id NUMBER NOT NULL,
    item_id NUMBER REFERENCES evaluation_items(item_id),
    score NUMBER NOT NULL,
    feedback CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
COMMENT ON TABLE interview_evaluations IS '면접 평가 결과 (Interview Evaluations)';

-- =============================================
-- 15. RESUME_ANALYSES (이력서 분석 기반 리포트)
-- =============================================
CREATE TABLE RESUME_ANALYSES (
    ANALYSIS_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FILE_NAME VARCHAR2(255) NOT NULL,
    S3_PATH VARCHAR2(500),
    SUMMARY CLOB,
    TECH_STACK CLOB,
    EXPERIENCE CLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE RESUME_ANALYSES IS '이력서 AI 분석 리포트';
COMMENT ON COLUMN RESUME_ANALYSES.SUMMARY IS '이력서 전체 요약 내용';
COMMENT ON COLUMN RESUME_ANALYSES.TECH_STACK IS '추출된 기술 스택 정보';
COMMENT ON COLUMN RESUME_ANALYSES.EXPERIENCE IS '주요 프로젝트 및 경력 요약';

-- =============================================
-- 16. DML (기초 데이터 삽입)
-- =============================================

-- [Job Roles]
INSERT INTO job_roles (role_id, role_name, description) VALUES (1, 'Frontend', 'Next.js, React 기반 클라이언트 개발');
INSERT INTO job_roles (role_id, role_name, description) VALUES (2, 'Backend', 'Java, Spring 기반 서버 아키텍처 개발');
INSERT INTO job_roles (role_id, role_name, description) VALUES (3, 'Data/Python', 'Python 기반 데이터 모델링 및 AI 서비스 개발');

-- [Rubric Categories]
INSERT INTO rubric_categories (category_id, name, description, weight) VALUES (10, '기술적 숙련도', '선택한 스택의 깊이 있는 이해와 활용 능력', 0.5);
INSERT INTO rubric_categories (category_id, name, description, weight) VALUES (11, '문제 해결 및 설계', '장애 대응 및 효율적인 시스템 설계 역량', 0.3);
INSERT INTO rubric_categories (category_id, name, description, weight) VALUES (12, '협업 및 태도', '코드 품질 유지 및 기술 커뮤니케이션 능력', 0.2);

-- [Evaluation Items]
INSERT INTO evaluation_items (category_id, item_name, definition) VALUES (10, '기술 스택의 깊이', '사용하는 언어/프레임워크의 동작 원리를 이해하고 한계점을 인지하는가?');
INSERT INTO evaluation_items (category_id, item_name, definition) VALUES (10, '시스템 설계 능력', '확장성과 유지보수를 고려하여 구조를 설계할 수 있는가?');
INSERT INTO evaluation_items (category_id, item_name, definition) VALUES (11, '예외 처리 및 안정성', '해결책 제시 시 에지 케이스(Edge Case)와 예외 상황을 고려하는가?');
INSERT INTO evaluation_items (category_id, item_name, definition) VALUES (12, '기술 커뮤니케이션', '기술적 개념을 비전공자나 동료가 이해하기 쉽게 설명할 수 있는가?');

-- [Companies]
INSERT INTO companies (company_id, name, industry, core_values) VALUES (1, 'TechGiant', 'IT', '["Customer Obsession", "Ownership", "Frugality"]');
INSERT INTO companies (company_id, name, industry, core_values) VALUES (2, 'FinSolutions', 'Finance', '["Trust", "Innovation", "Speed"]');

-- [Job Postings]
INSERT INTO job_postings (company_id, role_id, title, requirements) VALUES (1, 2, 'Senior Java Engineer', '8+ years experience in Spring Boot, Microservices');

-- [Interview Questions: Java/Spring]
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 10, 'Spring의 Bean 생명주기와 @PostConstruct의 용도를 설명해주세요.', '컨테이너 관리 이해', '생성->의존성주입->초기화 호출 순서 설명');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 10, 'JDK Dynamic Proxy와 CGLIB Proxy의 차이를 설명해주세요.', 'AOP 원리 파악', '인터페이스 유무에 따른 프록시 생성 방식 차이');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 11, '@Transactional 내부 호출 시 프록시 이슈 해결 방안은?', '트랜잭션 실무', 'Self-invocation 문제와 구조적 해결책');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 10, 'JVM G1GC의 작동 방식과 장점을 설명해주세요.', '메모리 관리', '리전 기반 관리 및 STW 감소 원리');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 10, 'Spring Security의 인증 필터 체인 흐름을 설명해주세요.', '보안 아키텍처', 'SecurityContextHolder 및 FilterChain 흐름');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 11, 'JPA N+1 문제 해결을 위한 Fetch Join 활용법은?', '데이터 최적화', '지연 로딩 이슈와 최적화 쿼리 작성');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 10, 'Spring Boot Auto Configuration의 작동 원리는?', '프레임워크 자동화', 'spring.factories를 통한 자동 설정 메커니즘');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 11, 'ConcurrentHashMap이 HashMap보다 안전한 원리는?', '동시성 제어', 'Segment Lock 또는 CAS 연산 활용');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 11, 'MSA 환경에서 서킷 브레이커의 역할은 무엇인가요?', '장애 전파 방지', '장애 시 호출 차단 및 시스템 보호');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (2, 12, 'Java 17의 Record 도입 시 이점은 무엇인가요?', '최신 문법 활용', '불변 데이터 객체화와 가독성 향상');

-- [Interview Questions: Next.js]
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 10, 'Next.js SSR과 SSG의 적절한 사용 사례를 설명해주세요.', '렌더링 전략', '데이터 갱신 빈도에 따른 선택 기준');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 10, 'Server Component와 Client Component의 경계는?', '최신 아키텍처', '서버 사이드 직렬화 및 클라이언트 상호작용 구분');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 11, 'ISR을 활용한 정적 페이지 업데이트 방식을 설명해주세요.', '성능 최적화', 'revalidate를 통한 백그라운드 갱신');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 10, 'SEO를 위한 Metadata API 활용 방안은?', '검색 엔진 최적화', '동적 메타데이터 생성 및 SEO 전략');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 11, 'Next.js Image 컴포넌트가 성능에 주는 이점은?', '웹 최적화', 'Lazy Loading 및 이미지 리사이징');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 10, 'Middleware를 이용한 인증 제어 구현 방법은?', '보안 및 라우팅', 'Edge Runtime 기반 리다이렉션 처리');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 11, 'Hydration Error 발생 원인과 해결책은?', '디버깅 역량', '서버-클라이언트 HTML 불일치 해결');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 11, 'Zustand나 React Query를 서버 컴포넌트와 조합하는 방법은?', '상태 관리 설계', 'Prefetching 및 Hydration 가이드');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 10, 'Next.js의 Data Cache 메커니즘을 설명해주세요.', '캐싱 전략', 'fetch 요청 중복 제거 및 유지 기간');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (1, 11, 'T3 Stack과 같은 풀스택 구조의 장점은 무엇인가요?', '생산성/기술 스택', 'Type Safety와 엔드투엔드 타입 공유');

-- [Interview Questions: Python]
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 10, 'Python GIL이 멀티 쓰레딩 성능에 미치는 영향은?', '언어 제약 이해', '싱글 쓰레드 실행 보장과 멀티프로세싱 필요성');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 11, 'asyncio의 Event Loop 동작 원리를 설명해주세요.', '비동기 처리', 'I/O 바운드 작업의 논블로킹 처리 방식');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 10, 'Python List와 Tuple의 메모리 관점 차이는?', '데이터 구조', '가변성 여부에 따른 최적화 방식');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 11, 'Decorator를 활용한 실무 사례를 설명해주세요.', '코드 재사용', '로깅, 인증 등 횡단 관심사 분리');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 10, 'Generator와 yield의 메모리 효율성을 설명해주세요.', '대용량 처리', 'Lazy Evaluation을 통한 이터레이터 활용');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 11, 'FastAPI 의존성 주입(DI)의 장점은?', '프레임워크 활용', '코드 테스트 및 의존성 관리의 용이성');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 10, 'Poetry와 같은 패키지 관리 도구의 필요성은?', '환경 관리', '결정론적 의존성 해결 및 환경 격리');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 11, 'NumPy의 벡터화 연산이 빠른 이유는?', '연산 최적화', 'C 구현 루프 및 CPU 병렬 연산 활용');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 11, 'Python의 순환 참조와 GC 대응 방법은?', '메모리 관리', '참조 횟수 계산 방식과 gc 모듈의 역할');
INSERT INTO interview_questions (role_id, category_id, question_text, intent, ideal_answer) VALUES (3, 12, 'Python Type Hinting을 실무에서 쓰는 이유는?', '코드 품질', '정적 분석 및 협업 시 가독성 증대');

COMMIT;
