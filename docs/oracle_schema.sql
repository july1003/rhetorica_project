-- =============================================
-- [AI 면접 플랫폼] Oracle Database Schema Design
-- =============================================
-- 작성자: Antigravity Agent
-- 설명: AI 모의면접 시스템을 위한 오라클 테이블 스키마 설계.
--       사용자 이력서 및 지원분야(3개) 입력을 포함하도록 INTERVIEWS 테이블을 확장함.
-- =============================================

-- 1. USERS (사용자 관리)
CREATE TABLE USERS (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL VARCHAR2(100) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    NAME VARCHAR2(50) NOT NULL,
    ROLE VARCHAR2(20) DEFAULT 'CANDIDATE' CHECK (ROLE IN ('CANDIDATE', 'RECRUITER', 'ADMIN')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE USERS IS '사용자 계정 및 역할 정보';
COMMENT ON COLUMN USERS.ROLE IS '사용자 권한 (지원자, 채용담당자, 관리자)';

-- 2. INTERVIEWS (면접 세션 및 사용자 입력 정보)
-- 수정사항: 이력서 정보(RESUME)와 지원분야(TARGET_JOB_TITLES) 컬럼 추가
CREATE TABLE INTERVIEWS (
    INTERVIEW_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER REFERENCES USERS(USER_ID) ON DELETE CASCADE,
    
    -- [사용자 입력 데이터]
    -- 이력서 파일 경로 (업로드된 파일 위치)
    RESUME_FILE_PATH VARCHAR2(500),
    -- 이력서에서 추출한 텍스트 (AI 분석용, LLM Context)
    RESUME_TEXT CLOB,
    -- 지원 분야 (최대 3개, JSON 배열 형태 권장 예: '["Backend", "AI", "Cloud"]')
    TARGET_JOB_TITLES CLOB CHECK (TARGET_JOB_TITLES IS JSON), 
    
    -- [세션 상태 관리]
    JOB_POSTING_ID NUMBER, -- (Optional) 특정 공고 지원일 경우
    STATUS VARCHAR2(20) DEFAULT 'SCHEDULED' CHECK (STATUS IN ('SCHEDULED', 'LIVE', 'COMPLETED', 'ANALYZING', 'DONE')),
    START_TIME TIMESTAMP,
    END_TIME TIMESTAMP,
    OVERALL_SCORE NUMBER(5, 2), -- 100점 만점 기준
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE INTERVIEWS IS '면접 세션 정보 및 지원자 입력 스펙';
COMMENT ON COLUMN INTERVIEWS.RESUME_TEXT IS 'RAG 분석을 위해 이력서 PDF/Word에서 추출한 원문 텍스트';
COMMENT ON COLUMN INTERVIEWS.TARGET_JOB_TITLES IS '사용자가 선택한 3가지 지원 분야 (JSON Array)';

-- 3. QUESTIONS (질문 은행)
CREATE TABLE QUESTIONS (
    QUESTION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CONTENT CLOB NOT NULL, -- 질문 내용 (텍스트가 길 수 있으므로 CLOB)
    CATEGORY VARCHAR2(100), -- 직무/기술 분야 (예: Network, Algorithm, Personality)
    DIFFICULTY NUMBER(1) DEFAULT 1 CHECK (DIFFICULTY BETWEEN 1 AND 5), -- 난이도 1~5
    RUBRIC_JSON CLOB CHECK (RUBRIC_JSON IS JSON), -- AI 평가 기준 (JSON 포맷)
    VECTOR_ID VARCHAR2(255) -- Vector DB(Pinecone/Pgvector)의 임베딩 ID 매핑
);

COMMENT ON TABLE QUESTIONS IS '면접 질문 풀 및 평가 기준';
COMMENT ON COLUMN QUESTIONS.RUBRIC_JSON IS '이 질문에 대한 모범 답안 키워드 및 평가 가이드라인';

-- 4. TRANSCRIPTS (대화 기록)
CREATE TABLE TRANSCRIPTS (
    TRANSCRIPT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INTERVIEW_ID NUMBER REFERENCES INTERVIEWS(INTERVIEW_ID) ON DELETE CASCADE,
    SPEAKER VARCHAR2(10) CHECK (SPEAKER IN ('AI', 'USER')), -- 화자 구분
    CONTENT CLOB, -- 발화 내용 (STT 결과 또는 AI 질문)
    SENTIMENT_SCORE NUMBER(4, 3), -- 감정 점수 (-1.0 ~ 1.0)
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE TRANSCRIPTS IS '면접 실시간 대화 로그 (STT/TTS)';

-- 5. EVALUATION_REPORTS (최종 평가 리포트)
CREATE TABLE EVALUATION_REPORTS (
    REPORT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INTERVIEW_ID NUMBER REFERENCES INTERVIEWS(INTERVIEW_ID) ON DELETE CASCADE,
    
    -- [정량적 평가 점수]
    TECHNICAL_SCORE NUMBER(5, 2),     -- 기술 역량 점수
    COMMUNICATION_SCORE NUMBER(5, 2), -- 의사소통 능력 점수
    CULTURAL_FIT_SCORE NUMBER(5, 2),  -- 조직 적합성 점수
    
    -- [정성적 피드백]
    SUMMARY_TEXT CLOB, -- 전체 총평
    DETAILS_JSON CLOB CHECK (DETAILS_JSON IS JSON), -- 질문별 세부 평가 및 피드백 (구조화된 JSON)
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE EVALUATION_REPORTS IS '면접 종료 후 생성되는 종합 분석 결과';
